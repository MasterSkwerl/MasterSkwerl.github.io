<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://unpkg.com/@atlaskit/css-reset@2.0.0/dist/bundle.css" media="all">
        <script src="https://connect-cdn.atl-paas.net/all.js"></script>
    </head>
    <body>
        <section id="content" class="ac-content">

            <div id="tableData">Starting Content</div>



<script type="text/javascript">

AP.events.on('ISSUE_GLANCE_OPENED', function() {
    AP.context.getContext(function(response){
        console.log("Jira Issue Key", response.jira.issue.key);
        issueKey = response.jira.issue.key;
        GetIssueData(issueKey);
    });
  });

function GetIssueData(issueKey){
    AP.request(`/rest/api/3/issue/${issueKey}`)
    .then(data => {
        var issue = data.body;
        var jsonObject = JSON.parse(data.body);
        GetExtendedUserInfo(jsonObject.fields.reporter.accountId);
    })
    .catch(e => alert(e.err));
}

function GetExtendedUserInfo(accountId){
    var propertyKey = "custom";
    AP.request(`/rest/api/3/user/properties/${propertyKey}?accountId=${accountId}`)
    .then(data => {
        console.log("Extended User Data", data.body);
        var extendedData = JSON.parse(data.body);
        CreateTableFromJSON(extendedData);
    })
    .catch(e => alert(e.err));
}

function CreateTableFromJSON(jsonObject){
    console.log("Beginning Table Creation");

    console.log("Json Object", jsonObject);
    console.log("Json Object Values", jsonObject.value);
    
    var table = document.createElement("table");

    console.log("Beginning to Parse Keys")

    for (let [key, value] of Object.entries(jsonObject.value)) {
        
        console.log(`${key}: ${value}`);

        tr = table.insertRow(-1);

        var headerCell = tr.insertCell(-1);
        headerCell.innerHTML = key;

        var valueCell = tr.insertCell(-1);
        valueCell.innerHTML = value;
    }

    console.log("Attempting to Add Table to DIV");

    var divContainer = document.getElementById("tableData");
    divContainer.innerHTML = "";
    divContainer.appendChild(table);
}



</script>

        </section>
    </body>
</html>
