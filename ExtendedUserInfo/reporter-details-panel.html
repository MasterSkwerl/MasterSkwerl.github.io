<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://unpkg.com/@atlaskit/css-reset@2.0.0/dist/bundle.css" media="all">
        <script src="https://connect-cdn.atl-paas.net/all.js"></script>
    </head>
    <body>
        <section id="content" class="ac-content">

            <div name="tableData"></div>



<script type="text/javascript">

AP.events.on('ISSUE_GLANCE_OPENED', function() {
    AP.context.getContext(function(response){
        console.log("Jira Issue Key", response.jira.issue.key);
        issueKey = response.jira.issue.key;
        GetIssueData(issueKey);
    });
  });

function GetIssueData(issueKey){
    AP.request(`/rest/api/3/issue/${issueKey}`)
    .then(data => {
        var issue = data.body;
        console.log("Jira Fields", issue);
        var jsonObject = (new Function("return " + data.body))();
        GetReporterData(jsonObject.fields.reporter.accountId);
    })
    .catch(e => alert(e.err));
}

function GetReporterData(accountId){
    AP.request(`/rest/api/3/user?accountId=${accountId}`)
    .then(data => {
        console.log("Jira Reporter Data", data.body);
        GetExtendedUserInfo(accountId);
    })
    .catch(e => alert(e.err));
}

function GetExtendedUserInfo(accountId){
    var propertyKey = "custom";
    AP.request(`/rest/api/3/user/properties/${propertyKey}?accountId=${accountId}`)
    .then(data => {
        console.log("Extended User Data", data.body);
        CreateTableFromJSON();
    })
    .catch(e => alert(e.err));
}

function CreateTableFromJSON() {
        var jsonObject = {
            "key":"custom",
            "value":{
                "company":"unlocked",
                "vip":"true"
                }
            }

        console.log("Json Object", jsonObject);
        console.log("Json Object Values", jsonObject.value);
        
        var table = document.createElement("table");

        for (var key in jsonObject.value) {
            
            tr = table.insertRow(-1);

            var headerCell = tr.insertCell(-1);
            headerCell.innerHTML = key;

            var valueCell = tr.insertCell(-1);
            valueCell.innerHTML = jsonObject.value[key];
        }
    
        var divContainer = document.getElementsByName("tableData");
        divContainer.innerHTML = "";
        divContainer.appendChild(table);
    }



</script>

        </section>
    </body>
</html>
