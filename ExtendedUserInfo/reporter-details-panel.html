<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://unpkg.com/@atlaskit/css-reset@2.0.0/dist/bundle.css" media="all">
        <script src="https://connect-cdn.atl-paas.net/all.js"></script>
    </head>
    <body>
        <section id="content" class="ac-content">

            <div id="tableData">Starting Content</div>



<script type="text/javascript">

AP.events.on('ISSUE_GLANCE_OPENED', function() {
    AP.context.getContext(function(response){
        issueKey = response.jira.issue.key;
        var issueData = GetIssueData(issueKey);
        var reporterData = GetExtendedUserInfo(issueData.fields.reporter.accountId, "custom");
        UpdateTable(reporterData);
    });
  });

function GetIssueData(issueKey){
    AP.request(`/rest/api/3/issue/${issueKey}`)
    .then(data => {
        var jsonObject = JSON.parse(data.body);
        return jsonObject;
    })
    .catch(e => console.error(e.err));
}

function GetExtendedUserInfo(accountId, propertyKey){
    AP.request(`/rest/api/3/user/properties/${propertyKey}?accountId=${accountId}`)
    .then(data => {
        console.log("Extended User Data", data.body);
        return JSON.parse(data.body);
    })
    .catch(e => alert(e.err));
}

function UpdateTable(jsonObject){
    var table = document.createElement("table");

    for (let [key, value] of Object.entries(jsonObject.value)) {
        tr = table.insertRow(-1);
        var headerCell = tr.insertCell(-1);
        headerCell.innerHTML = key;
        var valueCell = tr.insertCell(-1);
        valueCell.innerHTML = value;
    }

    var divContainer = document.getElementById("tableData");
    divContainer.innerHTML = "";
    divContainer.appendChild(table);
}

</script>
        </section>
    </body>
</html>
